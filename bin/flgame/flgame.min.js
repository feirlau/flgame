var fl;!function(t){var e=function(e){function n(t,n,i,s){void 0===n&&(n=null),void 0===i&&(i=!1),void 0===s&&(s=!1),e.call(this,t,i,s),this.data=n}__extends(n,e);var i=(__define,n);return p=i.prototype,p.clone=function(){var e=new t.GlobalEvent(this.type,this.data,this.bubbles,this.cancelable);return e},n}(egret.Event);t.GlobalEvent=e,egret.registerClass(e,"fl.GlobalEvent")}(fl||(fl={}));var fl;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.eventListeners_=new t.Dictionary}__extends(n,e);var i=(__define,n);return p=i.prototype,n.getInstance=function(){return t.EventManager.instance_=t.EventManager.instance_||new t.EventManager,t.EventManager.instance_},p.dispatchEvent=function(t){var n=this;return n.hasEventListener(t.type)||t.bubbles?e.prototype.dispatchEvent.call(this,t):!0},p.addEventListener=function(t,n,i,s,r){void 0===s&&(s=!1),void 0===r&&(r=0);var o=t+"_"+s,a=this.eventListeners_.getItem(o);null==a&&(a=new Array,this.eventListeners_.setItem(o,a));var c=a.indexOf(n);-1==c&&(e.prototype.addEventListener.call(this,t,n,null,s,r),a.push(n))},p.removeEventListener=function(t,n,i,s){void 0===s&&(s=!1);var r=t+"_"+s,o=this.eventListeners_.getItem(r),a=o?o.indexOf(n):-1;-1!=a&&(e.prototype.removeEventListener.call(this,t,n,null,s),o.splice(a,1))},p.removeListeners=function(t,e){void 0===t&&(t=null),void 0===e&&(e=!1);var n;if(t){n=t+"_"+e;var i=this.eventListeners_.getItem(n);for(var s in i){var r=i[s];this.removeEventListener(t,r,null,e)}this.eventListeners_.delItem(n)}else for(var o in this.eventListeners_.map)n=this.eventListeners_.map[o][0],n&&this.removeListeners(n,e)},p.removeAllListeners=function(){this.removeListeners(null,!1),this.removeListeners(null,!0)},n}(egret.EventDispatcher);t.EventManager=e,egret.registerClass(e,"fl.EventManager"),t.eventMgr=t.EventManager.getInstance()}(fl||(fl={}));var fl;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.eventMgr=t.eventMgr,this.netMgr=t.netMgr}__extends(n,e);var i=__define,s=n;return p=s.prototype,i(p,"protocols",function(){return this.mapProtocols},function(t){this.mapProtocols=t}),p.process=function(t,e){void 0===e&&(e=0)},p.sendPack=function(t,e){void 0===e&&(e=""),this.netMgr.sendPack(t,e)},p.sendBytes=function(t,e){void 0===e&&(e=""),this.netMgr.sendBytes(t,e)},p.dispatchEvent=function(t){this.eventMgr.dispatchEvent(t)},n}(t.Actor);t.BaseAction=e,egret.registerClass(e,"fl.BaseAction")}(fl||(fl={}));var fl;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.actionCache_=new t.Dictionary,this.actionClazz_=[]}__extends(n,e);var i=(__define,n);return p=i.prototype,n.getInstance=function(){return null==t.ActionManager.instance_&&(t.ActionManager.instance_=new t.ActionManager),t.ActionManager.instance_},p.initActions=function(e){this.injector_=e,this.injector_.mapValue(t.ActionManager,this)},p.injectAction=function(t){var e=this.actionClazz_.indexOf(t);if(this.injector_&&t&&-1==e){this.injector_.mapSingleton(t);var n=this.injector_.getInstance(t);this.mapAction(n),this.actionClazz_.push(t)}},p.uninjectAction=function(t){var e=this.actionClazz_.indexOf(t);if(this.injector_&&t&&e>=0){var n=this.injector_.getInstance(t);this.unmapAction(n),this.injector_.unmap(t),this.actionClazz_.splice(e,1)}},p.mapAction=function(t){if(t)for(var e in t.protocols){var n=t.protocols[e];null!=n&&this.setAction(t,n)}},p.unmapAction=function(t){for(var e in this.actionCache_.map){var n=this.actionCache_.map[e][0];this.actionCache_.getItem(n)==t&&this.actionCache_.delItem(n)}},p.getActionByClass=function(t){var e,n=this.actionClazz_.indexOf(t);return this.injector_&&t&&-1!=n&&(e=this.injector_.getInstance(t)),e},p.getAction=function(t){var e=this.actionCache_.getItem(t);return e},p.setAction=function(t,e){return this.actionCache_.getItem(e)&&this.removeAction(e),this.actionCache_.setItem(e,t),t},p.removeAction=function(t){var e=null;return this.actionCache_.hasOwnProperty(t)&&(e=this.actionCache_.getItem(t),this.actionCache_.delItem(t)),e},n}(egret.HashObject);t.ActionManager=e,egret.registerClass(e,"fl.ActionManager"),t.actionMgr=t.ActionManager.getInstance()}(fl||(fl={}));var fl;!function(t){var e=function(e){function n(){e.apply(this,arguments)}__extends(n,e);var i=(__define,n);return p=i.prototype,n.init=function(){t.Actions.inited||(t.Actions.inited=!0)},n.injectAction=function(e){t.actionMgr.injectAction(e)},n.uninjectAction=function(e){t.actionMgr.uninjectAction(e)},n.inited=!1,n}(egret.HashObject);t.Actions=e,egret.registerClass(e,"fl.Actions")}(fl||(fl={}));var fl;!function(t){var e=function(e){function n(t){void 0===t&&(t=null),e.call(this,t,!1)}__extends(n,e);var i=(__define,n);return p=i.prototype,n.getInstance=function(e){void 0===e&&(e=null),e=e;var n=t.GameContext.instances_.getItem(e);return n||(n=new t.GameContext(e),t.GameContext.instances_.setItem(e,n)),n},p.createEventDispatcher=function(){return t.eventMgr},p.startup=function(){this.injector.mapValue(t.EventManager,t.eventMgr),t.actionMgr.initActions(this.injector),e.prototype.startup.call(this)},p.mapView=function(t,e,n,i,s,r){void 0===n&&(n=null),void 0===i&&(i=null),void 0===s&&(s=!0),void 0===r&&(r=!0),this.mediatorMap.mapView(t,e,i,s,r),n&&n.stage&&this.mediatorMap.createMediator(n)},p.unmapView=function(t){this.mediatorMap.unmapView(t)},p.injectAction=function(e){t.actionMgr.injectAction(e)},p.uninjectAction=function(e){t.actionMgr.uninjectAction(e)},n.instances_=new t.Dictionary,n}(t.Context);t.GameContext=e,egret.registerClass(e,"fl.GameContext")}(fl||(fl={}));var fl;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.viewList_=new Array,this.actionList_=new Array}__extends(e,t);var n=(__define,e);return p=n.prototype,p.onRemove=function(){this.unmapActions(),this.unmapMediators(),t.prototype.onRemove.call(this)},p.unmapMediators=function(){for(var t in this.viewList_){var e=this.viewList_[t];this.mediatorMap.unmapView(e)}this.viewList_.splice(0,this.viewList_.length)},p.mapMediator=function(t,e,n,i,s,r){void 0===n&&(n=null),void 0===i&&(i=null),void 0===s&&(s=!0),void 0===r&&(r=!0);var o=this.viewList_.indexOf(t);-1!=o?console.log("[mapMediator] Mediator Class has already been mapped to a View Class in this context - "+t):(this.mediatorMap.mapView(t,e,i,s,r),n&&n.stage&&this.mediatorMap.createMediator(n),this.viewList_.push(t))},p.unmapMediator=function(t){var e=this.viewList_.indexOf(t);-1!=e?(this.mediatorMap.unmapView(t),this.viewList_.splice(e,1)):console.log("[unmapMediator] Mediator Class has not been mapped to a View Class in this context - "+t)},p.unmapActions=function(){for(var t in this.actionList_){var e=this.actionList_[t];this.actionManager.uninjectAction(e)}this.actionList_.splice(0,this.actionList_.length)},p.injectAction=function(t){var e=this.actionList_.indexOf(t);-1!=e?console.log("[injectAction] Action Class has already been injected in this context - "+t):(this.actionManager.injectAction(t),this.actionList_.push(t))},p.uninjectAction=function(t){var e=this.actionList_.indexOf(t);-1!=e?(this.actionManager.uninjectAction(t),this.actionList_.splice(e,1)):console.log("[uninjectAction] Action Class has not been injected in this context - "+t)},e}(t.Mediator);t.GameMediator=e,egret.registerClass(e,"fl.GameMediator")}(fl||(fl={}));var fl;!function(t){var e=function(e){function n(){e.apply(this,arguments)}__extends(n,e);var i=(__define,n);return p=i.prototype,n.init=function(e){if(void 0===e&&(e=null),t.Modules.inited)return e;t.Modules.inited=!0,e=e||[],e.push(t.Modules.registerViews);var n;return n=function(){},e.push(n),e},n.registerViews=function(){},n.inited=!1,n}(egret.HashObject);t.Modules=e,egret.registerClass(e,"fl.Modules")}(fl||(fl={}));var fl;!function(t){var e=function(e){function n(t,n,i){e.call(this),this.dataCache_=new Array,this._cachCmd=!1,this.id=i,this.ip=t,this.port=n,this.socket=new egret.WebSocket,this.socket.type=egret.WebSocket.TYPE_BINARY,this.socket.addEventListener(egret.Event.CONNECT,this.onConnect,this),this.socket.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onReceived,this),this.socket.addEventListener(egret.Event.CLOSE,this.onClose,this),this.socket.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onError,this),this._receBytes=new egret.ByteArray,this.open()}__extends(n,e);var i=(__define,n);return p=i.prototype,p.open=function(){this.socket.connected||this.socket.connect(this.ip,this.port)},p.close=function(){this.socket.connected&&this.socket.close(),this.dataCache_=new Array},p.forceClose=function(){this.close(),t.eventMgr.dispatchEvent(new t.GlobalEvent(t.BaseNet.EVENT_CLIENT_CLOSE))},p.onConnect=function(t){for(var e=this.dataCache_.shift();e;)this.send(e),e=this.dataCache_.shift()},p.notifyClose=function(){t.eventMgr.dispatchEvent(new t.GlobalEvent(t.BaseNet.EVENT_NET_ERR,this.id))},p.onClose=function(t){egret.log("[BaseNet.onClose] "+t),this.notifyClose()},p.onError=function(t){egret.error("[BaseNet.onError] "+t),this.notifyClose()},p.send=function(t){this.socket.connected?(this.socket.writeBytes(t,0,t.length),this.socket.flush()):this.dataCache_.push(t)},p.onReceived=function(t){var e=new egret.ByteArray;if(this.socket.readBytes(e),0!=e.length)for(this._receBytes.position=this._receBytes.length,this._receBytes.writeBytes(e,0,e.length);this.processPacks(););},p.processPacks=function(){if(this._receBytes.length<t.BasePack.HEAD_SIZE)return!1;this._receBytes.position=0;var e=this._receBytes.readUnsignedShort();if(e+=t.BasePack.HEAD_SIZE,this._receBytes.length<e)return!1;if(e>2*t.BasePack.MAX_PACK_SIZE)throw new t.Error("[BaseSocket.processPacks] unknow package size: "+e);var n=new egret.ByteArray;n.writeBytes(this._receBytes,0,t.BasePack.HEAD_SIZE);var i=new egret.ByteArray;e!=t.BasePack.HEAD_SIZE&&i.writeBytes(this._receBytes,t.BasePack.HEAD_SIZE,e-t.BasePack.HEAD_SIZE),n.position=2;var s=n.readUnsignedInt();return s>>>31==1&&(egret.log("compressed protocol: "+s),s=2147483647&s,i=this.decryption(i)),n.position=t.BasePack.HEAD_SIZE,i.length&&(n.writeBytes(i,0,i.length),n.position=t.BasePack.HEAD_SIZE),this.processOrCache(s,n),n=new egret.ByteArray,this._receBytes.length>e&&n.writeBytes(this._receBytes,e,this._receBytes.length-e),this._receBytes.length=0,this._receBytes.position=0,n.length>0?(this._receBytes.writeBytes(n,0,n.length),!0):!1},p.decryption=function(t){return t},p.cachCmd=function(t){if(this._cachCmd=t,t)null==this._cachQueue&&(this._cachQueue=[]);else if(null!=this._cachQueue)for(;this._cachQueue.length>0;){var e=this._cachQueue.shift();this.processCmd(e.protocol,e.data)}},p.noCachCmd=function(t){return!1},p.processOrCache=function(t,e){0==this._cachCmd||this.noCachCmd(t)?this.processCmd(t,e):this._cachQueue.push({protocol:t,data:e})},p.processCmd=function(e,n){var i=egret.getTimer(),s=t.actionMgr.getAction(e);s?s.process(n,e):(s=t.actionMgr.getAction(t.Protocol.getProtocolType(e)),s?s.process(n,e):egret.error("[BaseNet.processCmd] unknow protocol "+e));var r=egret.getTimer()-i;r>=50&&egret.warn("[BaseNet.processCmd] handeltime: id:"+e+" time:"+r)},n.EVENT_NET_ERR="NetErrorEvent",n.EVENT_CLIENT_CLOSE="NetClientCloseEvent",n}(egret.HashObject);t.BaseNet=e,egret.registerClass(e,"fl.BaseNet")}(fl||(fl={}));var fl;!function(t){var e=function(e){function n(t){e.call(this),this.id=0,this.size=0,this.result=0,this.id=t}__extends(n,e);var i=(__define,n);return p=i.prototype,p.getBytes=function(){var e=new egret.ByteArray;return e.position=2,e.writeUnsignedInt(this.id),this.toBytes(e),e.position=0,this.size=e.length-t.BasePack.HEAD_SIZE,e.writeUnsignedShort(this.size),e},p.toBytes=function(t){},p.writeBytes=function(t){this.toBytes(t)},p.setBytes=function(e){e.position=t.BasePack.HEAD_SIZE,this.fromBytes(e),this.dealError(this.result)},p.fromBytes=function(t){},p.readBytes=function(t){this.fromBytes(t)},p.resetBytesPos=function(e){e.position=t.BasePack.HEAD_SIZE},p.dealError=function(e){0!=e&&(t.eventMgr.dispatchEvent(new t.GlobalEvent(t.BasePack.EVENT_PACK_ERR,e)),egret.error("[BasePack.dealError] "+this.id+":"+e))},n.EVENT_PACK_ERR="PackErrorEvent",n.HEAD_SIZE=6,n.MAX_PACK_SIZE=65536,n}(egret.HashObject);t.BasePack=e,egret.registerClass(e,"fl.BasePack")}(fl||(fl={}));var fl;!function(t){var e=function(t){function e(e,n,i){t.call(this,e,n,i),this.cachCmd(!0)}__extends(e,t);var n=(__define,e);return p=n.prototype,p.noCachCmd=function(t){return!1},e}(t.BaseNet);t.GameNet=e,egret.registerClass(e,"fl.GameNet")}(fl||(fl={}));var fl;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.netCache_=new t.Dictionary}__extends(n,e);var i=__define,s=n;return p=s.prototype,n.getInstance=function(){return null==t.NetManager.instance_&&(t.NetManager.instance_=new t.NetManager),t.NetManager.instance_},p.addNet=function(e,n,i,s){void 0===i&&(i=t.NetManager.NET_GAME),void 0===s&&(s=null);var r=this.netCache_.getItem(i);return null==r&&(s=s||t.BaseNet,r=new s(e,n,i),this.netCache_.setItem(i,r)),r},p.getNet=function(e){void 0===e&&(e=t.NetManager.NET_GAME),e=e||t.NetManager.NET_GAME;var n=this.netCache_.getItem(e);return n},p.setNet=function(e,n){return void 0===n&&(n=t.NetManager.NET_GAME),this.netCache_.getItem(n)&&this.removeNet(n),this.netCache_.setItem(n,e),e},p.removeNet=function(e){void 0===e&&(e=t.NetManager.NET_GAME);var n=null;return this.netCache_.hasOwnProperty(e)&&(n=this.netCache_.getItem(e),n.close(),this.netCache_.delItem(e)),n},p.sendPack=function(e,n){void 0===n&&(n=t.NetManager.NET_GAME),this.sendBytes(e.getBytes(),n)},p.sendBytes=function(e,n){void 0===n&&(n=t.NetManager.NET_GAME);var i=this.getNet(n);i.send(e)},i(p,"isLocalNet",function(){var t=this.getNet();return t&&"192.168."==t.ip.substr(0,8)},function(t){}),n.NET_GAME="GameNet",n}(egret.HashObject);t.NetManager=e,egret.registerClass(e,"fl.NetManager"),t.netMgr=t.NetManager.getInstance()}(fl||(fl={}));var fl;!function(t){var e=function(e){function n(){e.call(this)}__extends(n,e);var i=(__define,n);return p=i.prototype,n.getProtocolType=function(e){return e/=t.Protocol.CMD_TYPE_BASE,Math.floor(e)},n.protocolEvent=function(t){return"EVENT_PROTOCOL_"+t},n.CMD_TYPE_BASE=1e5,n._inited=!1,n}(egret.HashObject);t.Protocol=e,egret.registerClass(e,"fl.Protocol")}(fl||(fl={}));